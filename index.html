<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vote Service</title>
</head>
<body>
<div class="main-container">
    <div class="header-row" style="max-width: 400px; display: flex; gap: 20px">
        <div>ID</div>
        <div>Current votes</div>
        <div>Send vote</div>
    </div>
    <div class="content-wrapper"></div>

    <div>
        <button onclick="getDocument('html')">HTML</button>
        <button onclick="getDocument('xml')">XML</button>
        <button onclick="getDocument('json')">JSON</button>
    </div>
</div>

<script>
    const contentWrapper = document.querySelector('.content-wrapper');

    getVariants = async () => {
        const response = await fetch('/variants');
        return response.json();
    }

    getStats = async () => {
        const response = await fetch('/stats', {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
        });
        return response.json();
    }

    onVoteClick = async (id, votes) => {
        await fetch('/vote', {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
            body: JSON.stringify({id})
        });

        votes.forEach(oldVote => oldVote.id === id ? oldVote.count += 1 : oldVote.count);
        renderData(votes);
    }

    renderData = (votes) => {
        contentWrapper.innerHTML = null;

        votes.forEach(vote => {
            const row = document.createElement('div');
            row.style.display = 'flex';

            const id = document.createElement('div');
            id.textContent = vote.id;

            const current = document.createElement('div');
            current.style.marginLeft = '70px'
            current.textContent = vote.count;

            const action = document.createElement('button');
            action.style.marginLeft = '60px';
            action.style.width = '65px';
            action.textContent = vote.name;
            action.addEventListener('click', () => onVoteClick(vote.id, votes));

            row.append(id);
            row.append(current);
            row.append(action);
            contentWrapper.append(row);
        });
    }

    getDocument = async (type) => {
        const headers = new Headers();

        if (type === 'html') {
            headers.set('Accept', 'text/html');
        } else if (type === 'xml') {
            headers.set('Accept', 'application/xml');
        } else {
            headers.set('Accept', 'application/json');
        }

        const response = await fetch('/reports', {headers});
        const data = await response.blob();
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(new Blob([data]));
        link.download = `reports - ${new Date().toDateString()}.${type}`;
        link.click();
        link.remove();
    }

    init = async () => {
        const response = await Promise.all([getVariants(), getStats()]);
        const votes = response[0].data.map(item => {
            return {
                ...item,
                ...response[1].data.find(item2 => item.id === item2.id)
            }
        });

        renderData(votes);
    }

    init();
</script>
</body>
</html>
