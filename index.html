<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vote Service</title>
</head>
<body>
<div class="main-container">
    <form class="upload" method="post" enctype="multipart/form-data">
        <input type="file" name="file" required/>
        <br/>
        <label>
            Comment
            <input type="text" name="comment" required>
        </label>
        <br/>
        <input type="submit"/>
    </form>

    <div class="progress">Progress:</div>

    <div class="list" style="margin-top: 200px; display: flex; flex-direction: column; gap: 12px"></div>
</div>

<script>
    const config = {
        token: null
    };

    let socket = null;
    const progressDiv = document.querySelector('.progress');
    const uploadForm = document.querySelector('.upload');
    const listDiv = document.querySelector('.list');

    const initSocketListeners = () => {
        socket = new WebSocket(`ws://${location.host}`);
        socket.addEventListener('message', onSocketMessage);
        socket.addEventListener('close', onSocketClose);
        socket.addEventListener('error', onSocketError);
    }

    const removeSocketListeners = () => {
        config.token = null;
        socket.removeEventListener('message', onSocketMessage);
        socket.removeEventListener('close', onSocketClose);
        socket.removeEventListener('error', onSocketError);
    }

    const onSocketMessage = (message) => {
        const data = (JSON.parse(message.data));

        if (data.type === 'connection') {
            console.log('Connection start, id: ', data.id);
            config.token = data.id;
        }

        if (data.type === 'progress') {
            progressDiv.textContent = `Progress: ${data.progress}`;
        }
    }

    const onSocketError = () => {
        console.log('Connection error');
        removeSocketListeners();
        socket.close();
    }

    const onSocketClose = () => {
        console.log('Connection closed');
        removeSocketListeners();
    }

    const setupUploadAndProgress = () => {
        uploadForm.addEventListener('submit', (eo) => {
            eo.preventDefault();
            initSocketListeners();

            const file = eo.target.file.files[0];
            const comment = eo.target.comment.value;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('comment', comment);

            const interval = setInterval(() => {
                if (config.token) {
                    clearInterval(interval);
                    fetch(`http://${location.host}/upload-file`, {
                        method: 'POST',
                        headers: {"Token": config.token},
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(() => {
                            setTimeout(() => {
                                progressDiv.textContent = 'Progress: '
                            }, 1000);
                            getFiles();
                            removeSocketListeners();
                        })
                        .catch(error => console.log(error));
                }
            }, 500);
        });
    }

    const getFiles = () => {
        fetch(`http://${location.host}/get-files`, {
            method: 'GET',
        })
            .then(response => response.json())
            .then(data => {
                listDiv.innerHTML = null;

                data.filesInfo.forEach(item => {
                    const wrapper = document.createElement('div');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center'
                    wrapper.style.gap = '16px';

                    const link = document.createElement('a');
                    link.style.flexBasis = '20%';
                    link.href = `http://${location.host}/download/?name=` + item.originalname;
                    link.textContent = 'File: ' + item.originalname;

                    const comment = document.createElement('div');
                    comment.style.flexBasis = '20%';
                    comment.textContent = 'Comment: ' + item.comment;

                    const mimeType = document.createElement('div');
                    mimeType.style.flexBasis = '20%';
                    mimeType.textContent = 'Type: ' + item.mimetype;

                    const size = document.createElement('div');
                    size.textContent = 'Size: ' + (item.size / (1024 ** 2)).toFixed(2) + 'Mb';

                    wrapper.append(link);
                    wrapper.append(comment);
                    wrapper.append(mimeType);
                    wrapper.append(size);

                    listDiv.append(wrapper);
                });
            })
            .catch(error => console.log(error));
    }

    setupUploadAndProgress();
    getFiles();
</script>
</body>
</html>
