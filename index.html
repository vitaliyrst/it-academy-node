<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vote Service</title>
</head>
<body>
<div class="main-container">
    <div class="header-row" style="max-width: 400px; display: flex; gap: 20px">
        <div>ID</div>
        <div>Current votes</div>
        <div>Send vote</div>
    </div>
    <div class="content-wrapper"></div>
</div>

<script>
    const contentWrapper = document.querySelector('.content-wrapper');

    getVariants = async () => {
        const response = await fetch('http://localhost:5000/variants');
        return response.json();
    }

    getStats = async () => {
        const response = await fetch('http://localhost:5000/stats', {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
        });
        return response.json();
    }

    onVoteClick = async (id, votes) => {
        await fetch('http://localhost:5000/vote', {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
            body: JSON.stringify({id})
        });

        votes.forEach(oldVote => oldVote.id === id ? oldVote.count += 1 : oldVote.count);
        renderData(votes);
    }

    renderData = (votes) => {
        contentWrapper.innerHTML = null;

        votes.forEach(vote => {
            const row = document.createElement('div');
            row.style.display = 'flex';

            const id = document.createElement('div');
            id.textContent = vote.id;

            const current = document.createElement('div');
            current.style.marginLeft = '70px'
            current.textContent = vote.count;

            const action = document.createElement('button');
            action.style.marginLeft = '60px';
            action.style.width = '65px';
            action.textContent = vote.name;
            action.addEventListener('click', () => onVoteClick(vote.id, votes));

            row.append(id);
            row.append(current);
            row.append(action);
            contentWrapper.append(row);
        });
    }

    init = async () => {
        const response = await Promise.all([getVariants(), getStats()]);
        const votes = response[0].data.map(item => {
            return {
                ...item,
                ...response[1].data.find(item2 => item.id === item2.id)
            }
        });

        renderData(votes);
    }

    init();
</script>
</body>
</html>
